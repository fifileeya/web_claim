
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TPT Expense & Disbursement</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .tabs {
        display: flex;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 10px;
        gap: 10px;
    }
    .tab {
        flex: 1;
        padding: 15px;
        color: #fff;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s;
        background: rgba(255,255,255,0.1);
    }
    .tab.active {
        background: #fff;
        color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .tab:hover {
        background: rgba(255,255,255,0.2);
        transform: translateY(-1px);
    }
    .tab.active:hover {
        background: #fff;
        color: #667eea;
    }
    .tab-content {
        display: none;
        padding: 30px;
    }
    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .form-header {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    .form-header h2 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    th, td {
        border: 1px solid #e0e0e0;
        padding: 12px;
        text-align: left;
    }
    th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        font-weight: 600;
    }
    tr:nth-child(even) {
        background: #f8f9ff;
    }
    input, select {
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border 0.3s;
        width: 100%;
        box-sizing: border-box;
    }
    input:focus, select:focus {
        outline: none;
        border-color: #667eea;
    }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin: 5px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        font-size: 16px;
        padding: 12px 30px;
    }
    .btn-danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
    }
    .flex {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    .flex label {
        display: flex;
        flex-direction: column;
        gap: 5px;
        font-weight: 600;
        color: #333;
    }
    .signature-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 40px;
    }
    .signature {
        text-align: center;
        padding: 20px;
        border: 2px dashed #667eea;
        border-radius: 8px;
        background: #f8f9ff;
    }
    .signature select, .signature input {
        margin-bottom: 10px;
        text-align: center;
        font-weight: 600;
    }
    .signature-line {
        width: 100%;
        height: 80px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin: 10px 0;
        background: white;
    }
    .signature-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    .total-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 700;
        margin: 20px 0;
        text-align: right;
    }
    .download-section {
        text-align: center;
        margin: 30px 0;
        padding: 20px;
        background: #f8f9ff;
        border-radius: 8px;
    }
    .amount-input {
        text-align: right;
    }
    .total-row {
        background: #f0f0f0 !important;
        font-weight: bold;
    }

    /* PDF Print Styles */
    .pdf-page {
        display: none;
        background: white;
        padding: 40px;
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        box-sizing: border-box;
        color: #000;
    }
    .pdf-page.printing {
        display: block;
    }
    .pdf-header {
        text-align: center;
        margin-bottom: 30px;
    }
    .pdf-header h1 {
        margin: 0;
        font-size: 20px;
        color: #000;
        font-weight: bold;
    }
    .pdf-header h2 {
        margin: 10px 0 0 0;
        font-size: 18px;
        color: #000;
        font-weight: bold;
    }
    .pdf-header h1, .pdf-header h2 {
    color: #000 !important;
    }
    .pdf-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-size: 14px;
        color: #000;
    }
    .pdf-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    .pdf-table th,
    .pdf-table td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
        font-size: 12px;
        color: #000;
    }
    .pdf-table th {
        background: #f0f0f0;
        text-align: center;
        font-weight: bold;
        color: #000;
    }
    .pdf-table .amount-col {
        text-align: right;
    }
    .pdf-total {
        text-align: right;
        gap: 20px;
        font-weight: bold;
        font-size: 12px;
        margin: 15px 0;
        
    }
    .pdf-signatures {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 30px;
        margin-top: 60px;
    }
    .pdf-signature {
        text-align: center;
    }
    .pdf-signature-line {
        border-top: 1px solid #000;
        margin: 60px 20px 10px 20px;
    }
    @media print {
        body { background: white; padding: 0; }
        .container, .tabs, .btn, .download-section { display: none !important; }
        .pdf-page { display: block !important; }
    }
</style>
</head>
<body>
<div class="container">
    <div class="tabs">
        <button class="tab active" id="tab-disbursement">ðŸ’° Disbursement</button>
        <button class="tab" id="tab-expenses">ðŸ“‹ Expense Claim</button>
    </div>

    <!-- Disbursement -->
    <div id="disbursement" class="tab-content active">
        <div class="form-header">
            <h2>ðŸ’° Disbursement Authorization</h2>
        </div>
        <div class="flex">
            <label style="flex: 2;">
                Company:
                <input type="text" id="disb-company" readonly style="background: #f0f0f0;">
            </label>
            <label style="flex: 1;">
                Date:
                <input type="date" id="disb-date">
            </label>
            <label style="flex: 1;">
                No:
                <input type="text" id="disb-no" placeholder="Optional">
            </label>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 25%;">To</th>
                    <th style="width: 40%;">Description</th>
                    <th style="width: 15%;">Amount</th>
                    <th style="width: 10%;">VAT</th>
                    <th style="width: 10%;">Action</th>
                </tr>
            </thead>
            <tbody id="disbursementRows">
                <tr>
                    <td><input type="text" class="disb-to" readonly style="background: #f0f0f0;"></td>
                    <td><input type="text" class="disb-description" readonly style="background: #f0f0f0;"></td>
                    <td><input type="text" class="disb-amount amount-input" readonly style="background: #f0f0f0;"></td>
                    <td><input type="text" class="disb-vat amount-input" value="0.00"></td>
                    <td><button class="btn btn-danger" onclick="removeDisbursementRow(this)">âœ•</button></td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="2" style="text-align: right; font-weight: bold;">Total</td>
                    <td style="text-align: right; font-weight: bold;">$<span id="disbursementAmountTotal">0.00</span></td>
                    <td style="text-align: right; font-weight: bold;">$<span id="disbursementVATTotal">0.00</span></td>
                    <td></td>
                </tr>
                <tr class="total-row">
                    <td colspan="4" style="text-align: right; font-weight: bold; font-size: 16px;">Grand Total: $<span id="disbursementTotal">0.00</span></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        <button class="btn btn-primary" onclick="addDisbursementRow()">âž• Add Row</button>

        <div style="margin: 20px 0;">
            <label style="font-weight: 600; color: #333;">
                Paid on:
                <input type="date" id="disb-paid-date" style="width: 200px; display: inline-block; margin-left: 10px;">
            </label>
            <div style="margin: 15px 0;">
                <label style="font-weight: 600; color: #333; margin-right: 20px;">
                    <input type="checkbox" id="disb-cash"> Cash
                </label>
                <label style="font-weight: 600; color: #333; margin-right: 20px;">
                    <input type="checkbox" id="disb-wire" checked> Wire
                </label>
                <label style="font-weight: 600; color: #333;">
                    <input type="checkbox" id="disb-check"> Check
                </label>
            </div>
        </div>

        <div class="signature-section" id="disb-signatures">
            <div class="signature">
                <select class="disb-sign-title">
                    <option value="Managing Partner">Managing Partner</option>
                    <option value="Director">Director</option>
                    <option value="Manager">Manager</option>
                    <option value="Supervisor">Supervisor</option>
                </select>
                <input type="text" class="disb-sign-name" placeholder="Name">
                <div class="signature-line"></div>
                <div class="signature-label">Signature</div>
            </div>
        </div>
        <button class="btn btn-primary" onclick="addDisbursementSigner()" style="margin-top: 10px;">âž• Add Signatory</button>

        <div class="signature-section" style="margin-top: 20px;">
            <div class="signature">
                <div style="font-weight: bold; margin-bottom: 10px;">Accountant</div>
                <input type="text" id="disb-accountant" placeholder="Accountant Name" value="Fiya Lee">
                <div class="signature-line"></div>
                <div class="signature-label">Accountant Signature</div>
            </div>
        </div>
    </div>

    <!-- Expense Claim -->
    <div id="expenses" class="tab-content">
        <div class="form-header">
            <h2>ðŸ“‹ Expense Claim Form</h2>
        </div>

        <div class="flex">
            <label style="flex: 1;">
                Applicant:
                <input type="text" id="exp-applicant" placeholder="Applicant Name">
            </label>
        </div>

        <div class="flex">
            <label style="flex: 2;">
                Company:
                <select id="exp-company-select">
                    <option value="TPT CORPORATION LIMITED">TPT CORPORATION LIMITED</option>
                    <option value="Custom">Custom</option>
                </select>
            </label>
            <label style="flex: 1;">
                Date:
                <input type="date" id="exp-date">
            </label>
        </div>
        <input type="text" id="exp-company-custom" placeholder="Enter Custom Company Name" style="display:none; margin-bottom: 20px;">

        <div class="flex">
            <label style="flex: 1;">
                Original Currency:
                <select id="exp-original-currency">
                    <option value="TWD">TWD</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="JPY">JPY</option>
                    <option value="GBP">GBP</option>
                </select>
            </label>
            <label style="flex: 1;">
                Payment Currency:
                <select id="exp-payment-currency">
                    <option value="USD">USD</option>
                    <option value="TWD">TWD</option>
                    <option value="EUR">EUR</option>
                    <option value="JPY">JPY</option>
                    <option value="GBP">GBP</option>
                </select>
            </label>
            <label style="flex: 1;">
                FX Rate:
                <input type="number" id="exp-fx-rate" step="0.001" value="30.650">
            </label>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 10%;">Ref #</th>
                    <th style="width: 12%;">Date</th>
                    <th style="width: 38%;">Description /List Receipts separately</th>
                    <th style="width: 15%;">Amount (<span id="original-curr-label">TWD</span>)</th>
                    <th style="width: 15%;">Amount (<span id="payment-curr-label">USD</span>)</th>
                    <th style="width: 10%;">Action</th>
                </tr>
            </thead>
            <tbody id="expenseRows">
                <tr>
                    <td><input type="text" class="exp-ref"></td>
                    <td><input type="date" class="exp-item-date"></td>
                    <td><input type="text" class="exp-description"></td>
                    <td><input type="text" class="exp-amount-original amount-input"></td>
                    <td><input type="text" class="exp-amount-payment amount-input" readonly style="background: #f0f0f0;"></td>
                    <td><button class="btn btn-danger" onclick="removeExpenseRow(this)">âœ•</button></td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="3" style="text-align: right; font-weight: bold;">Total Amount</td>
                    <td style="text-align: right; font-weight: bold;"><span id="original-curr-total">TWD</span> <span id="totalOriginal">0.00</span></td>
                    <td style="text-align: right; font-weight: bold;"><span id="payment-curr-total">USD</span> <span id="totalPayment">0.00</span></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        <button class="btn btn-primary" onclick="addExpenseRow()">âž• Add Row</button>

        <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <strong>Note:</strong> Receipts must be attached
        </div>
    </div>

    <div class="download-section">
        <button class="btn btn-success" onclick="generatePDF()">ðŸ“¥ Download PDF</button>
    </div>
</div>

<!-- PDF Templates (Hidden) -->
<div id="pdf-disbursement" class="pdf-page">
    <div class="pdf-header">
        <h1 id="pdf-disb-company-name">TPT CORPORATION LIMITED</h1>
        <h2>Disbursement Authorization</h2>
    </div>
    <div class="pdf-info">
        <div>Application Date: <span id="pdf-disb-date"></span></div>
        <div>No: <span id="pdf-disb-no"></span></div>
    </div>
    <table class="pdf-table" id="pdf-disb-table">
        <thead>
            <tr>
                <th style="width: 25%;">To</th>
                <th style="width: 45%;">Description</th>
                <th style="width: 15%;">Amount</th>
                <th style="width: 15%;">VAT</th>
            </tr>
        </thead>
        <tbody id="pdf-disb-tbody"></tbody>
    </table>
    <div class="pdf-total">Total $<span id="pdf-disb-total"></span></div>
    <div style="margin: 20px 0; font-size: 14px;">
        <div>Paid on (M): <span id="pdf-disb-month"></span></div>
        <div style="margin-top: 10px;">
            by <span id="pdf-disb-payment"></span>
        </div>
    </div>
    <div class="pdf-signatures" id="pdf-disb-signatures"></div>
</div>

<div id="pdf-expenses" class="pdf-page">
    <div class="pdf-header">
        <h1 id="pdf-exp-company-name">TPT CORPORATION LIMITED</h1>
        <h2>Expenses claim form</h2>
    </div>
    <div style="text-align: right; margin-bottom: 10px; font-size: 14px;">
        FX Rate: <span id="pdf-exp-fx"></span>
    </div>
    <table class="pdf-table" id="pdf-exp-table">
        <thead>
            <tr>
                <th style="width: 10%;">Ref #</th>
                <th style="width: 12%;">Date</th>
                <th style="width: 43%;">Description /List Receipts separately</th>
                <th style="width: 17%;">Amount (<span id="pdf-original-curr"></span>)</th>
                <th style="width: 18%;">Amount (<span id="pdf-payment-curr"></span>)</th>
            </tr>
        </thead>
        <tbody id="pdf-exp-tbody"></tbody>
    </table>
    <div class="pdf-total">
        Total Amount <span id="pdf-exp-orig-curr"></span> <span id="pdf-exp-total-orig"></span>
        <span id="pdf-exp-pay-curr"></span> <span id="pdf-exp-total-pay"></span>
    </div>
    <div style="margin: 20px 0; font-style: italic; font-size: 12px;">
        Receipts must be attached
    </div>
    <div style="margin-top: 40px; font-size: 14px;">
        <div>Applicant: <span id="pdf-exp-applicant"></span></div>
        <div style="margin-top: 5px;">Date: <span id="pdf-exp-applicant-date"></span></div>
    </div>
</div>

<script>
// Tab switching
document.getElementById('tab-disbursement').addEventListener('click', function() {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('disbursement').classList.add('active');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
});

document.getElementById('tab-expenses').addEventListener('click', function() {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('expenses').classList.add('active');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
});

function formatNumber(num) {
    if (!num || isNaN(num)) return '0.00';
    return parseFloat(num).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function parseFormattedNumber(str) {
    if (!str) return 0;
    return parseFloat(str.toString().replace(/,/g, '')) || 0;
}

// Company select logic
document.getElementById('exp-company-select').addEventListener('change', function(e) {
    const custom = document.getElementById('exp-company-custom');
    if(e.target.value === 'Custom'){
        custom.style.display = 'block';
        custom.value = '';
    } else {
        custom.style.display = 'none';
    }
    syncToDisb();
});

// Currency label updates
document.getElementById('exp-original-currency').addEventListener('change', function(e) {
    const curr = e.target.value;
    document.getElementById('original-curr-label').textContent = curr;
    document.getElementById('original-curr-total').textContent = curr;
});

document.getElementById('exp-payment-currency').addEventListener('change', function(e) {
    const curr = e.target.value;
    document.getElementById('payment-curr-label').textContent = curr;
    document.getElementById('payment-curr-total').textContent = curr;
    updatePaymentAmounts();
});

document.getElementById('exp-fx-rate').addEventListener('change', function() {
    updatePaymentAmounts();
});

document.getElementById('exp-applicant').addEventListener('input', function() {
    syncToDisb();
});

document.getElementById('exp-company-custom').addEventListener('input', function() {
    syncToDisb();
});

// Sync expense to disbursement
function syncToDisb() {
    const applicant = document.getElementById('exp-applicant').value;
    const companySelect = document.getElementById('exp-company-select').value;
    const company = companySelect === 'Custom'
        ? document.getElementById('exp-company-custom').value
        : companySelect;

    document.getElementById('disb-company').value = company;

    const firstRow = document.querySelector('#disbursementRows tr');
    if (firstRow) {
        firstRow.querySelector('.disb-to').value = applicant;
        firstRow.querySelector('.disb-description').value = 'Expense Reimbursement';
    }
}

// Add/remove expense row
function addExpenseRow(){
    const tbody = document.getElementById('expenseRows');
    const tr = document.createElement('tr');
    tr.innerHTML = `
    <td><input type="text" class="exp-ref"></td>
    <td><input type="date" class="exp-item-date"></td>
    <td><input type="text" class="exp-description"></td>
    <td><input type="text" class="exp-amount-original amount-input"></td>
    <td><input type="text" class="exp-amount-payment amount-input" readonly style="background: #f0f0f0;"></td>
    <td><button class="btn btn-danger" onclick="removeExpenseRow(this)">âœ•</button></td>`;
    tbody.appendChild(tr);

    // Add event listeners to new inputs
    const newInput = tr.querySelector('.exp-amount-original');
    newInput.addEventListener('input', updatePaymentAmounts);
    newInput.addEventListener('blur', function() {
        const val = parseFormattedNumber(this.value);
        this.value = formatNumber(val);
    });
}

function removeExpenseRow(btn){
    btn.closest('tr').remove();
    updatePaymentAmounts();
}

// Add/remove disbursement row
function addDisbursementRow(){
    const tbody = document.getElementById('disbursementRows');
    const tr = document.createElement('tr');
    tr.innerHTML = `
    <td><input type="text" class="disb-to"></td>
    <td><input type="text" class="disb-description"></td>
    <td><input type="text" class="disb-amount amount-input"></td>
    <td><input type="text" class="disb-vat amount-input" value="0.00"></td>
    <td><button class="btn btn-danger" onclick="removeDisbursementRow(this)">âœ•</button></td>`;
    tbody.appendChild(tr);

    // Add event listeners
    const amtInput = tr.querySelector('.disb-amount');
    const vatInput = tr.querySelector('.disb-vat');

    amtInput.addEventListener('input', calculateDisbursementTotal);
    vatInput.addEventListener('input', calculateDisbursementTotal);

    amtInput.addEventListener('blur', function() {
        const val = parseFormattedNumber(this.value);
        this.value = formatNumber(val);
    });

    vatInput.addEventListener('blur', function() {
        const val = parseFormattedNumber(this.value);
        this.value = formatNumber(val);
    });
}

function removeDisbursementRow(btn){
    btn.closest('tr').remove();
    calculateDisbursementTotal();
}

// Payment conversion
function updatePaymentAmounts(){
    const fx = parseFloat(document.getElementById('exp-fx-rate').value) || 1;
    let totalOrig = 0, totalPay = 0;

    document.querySelectorAll('.exp-amount-original').forEach((input, index) => {
        const val = parseFormattedNumber(input.value);
        totalOrig += val;
        const payInput = document.querySelectorAll('.exp-amount-payment')[index];
        const payVal = val * fx;
        payInput.value = formatNumber(payVal);
        totalPay += payVal;
    });

    document.getElementById('totalOriginal').textContent = formatNumber(totalOrig);
    document.getElementById('totalPayment').textContent = formatNumber(totalPay);

    // Sync to disbursement first row
    const firstRow = document.querySelector('#disbursementRows tr');
    if (firstRow) {
        firstRow.querySelector('.disb-amount').value = formatNumber(totalPay);
        calculateDisbursementTotal();
    }
}

// Handle input formatting
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('exp-amount-original')) {
        const val = e.target.value.replace(/,/g, '');
        if (!isNaN(val) && val !== '') {
            e.target.value = val;
        }
        updatePaymentAmounts();
    }
    if (e.target.classList.contains('disb-amount') || e.target.classList.contains('disb-vat')) {
        const val = e.target.value.replace(/,/g, '');
        if (!isNaN(val) && val !== '') {
            e.target.value = val;
        }
        calculateDisbursementTotal();
    }
});

document.addEventListener('blur', function(e) {
    if (e.target.classList.contains('amount-input')) {
        const val = parseFormattedNumber(e.target.value);
        e.target.value = formatNumber(val);
    }
}, true);

function calculateDisbursementTotal(){
    let totalAmt = 0, totalVAT = 0;
    document.querySelectorAll('.disb-amount').forEach((a, i) => {
        const amt = parseFormattedNumber(a.value);
        const vat = parseFormattedNumber(document.querySelectorAll('.disb-vat')[i].value);
        totalAmt += amt;
        totalVAT += vat;
    });
    document.getElementById('disbursementAmountTotal').textContent = formatNumber(totalAmt);
    document.getElementById('disbursementVATTotal').textContent = formatNumber(totalVAT);
    document.getElementById('disbursementTotal').textContent = formatNumber(totalAmt + totalVAT);
}

// Add signer
function addDisbursementSigner(){
    const container = document.getElementById('disb-signatures');
    const div = document.createElement('div');
    div.className = 'signature';
    div.innerHTML = `
        <select class="disb-sign-title">
            <option value="Managing Partner">Managing Partner</option>
            <option value="Director">Director</option>
            <option value="Manager">Manager</option>
            <option value="Supervisor">Supervisor</option>
        </select>
        <input type="text" class="disb-sign-name" placeholder="Name">
        <div class="signature-line"></div>
        <div class="signature-label">Signature</div>
    `;
    container.appendChild(div);
}

// PDF generation
async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    // Prepare Disbursement PDF
    const disbCompany = document.getElementById('disb-company').value || 'TPT CORPORATION LIMITED';
    document.getElementById('pdf-disb-company-name').textContent = disbCompany;
    document.getElementById('pdf-disb-date').textContent = document.getElementById('disb-date').value;
    document.getElementById('pdf-disb-no').textContent = document.getElementById('disb-no').value;

    // Disbursement table
    const disbTbody = document.getElementById('pdf-disb-tbody');
    disbTbody.innerHTML = '';
    let totalAmt = 0, totalVAT = 0;
    document.querySelectorAll('#disbursementRows tr').forEach(tr => {
        const to = tr.querySelector('.disb-to').value;
        const desc = tr.querySelector('.disb-description').value;
        const amt = tr.querySelector('.disb-amount').value;
        const vat = tr.querySelector('.disb-vat').value;
        if(to || desc || amt || vat) {
            totalAmt += parseFormattedNumber(amt);
            totalVAT += parseFormattedNumber(vat);
            disbTbody.innerHTML += `<tr>
                <td>${to}</td>
                <td>${desc}</td>
                <td class="amount-col">${amt}</td>
                <td class="amount-col">${vat}</td>
            </tr>`;
        }
    });
    document.getElementById('pdf-disb-total').textContent = formatNumber(totalAmt + totalVAT);

    // Payment date - extract month
    const paidDate = document.getElementById('disb-paid-date').value;
    if (paidDate) {
        const date = new Date(paidDate);
        document.getElementById('pdf-disb-month').textContent = date.getMonth() + 1;
    }

    // Payment method
    const payMethods = [];
    if(document.getElementById('disb-cash').checked) payMethods.push('â˜‘Cash');
    else payMethods.push('â˜Cash');
    if(document.getElementById('disb-wire').checked) payMethods.push('â˜‘Wire');
    else payMethods.push('â˜Wire');
    if(document.getElementById('disb-check').checked) payMethods.push('â˜‘Check');
    else payMethods.push('â˜Check');
    document.getElementById('pdf-disb-payment').textContent = payMethods.join(' ');

    // Disbursement signatures
    const disbSigs = document.getElementById('pdf-disb-signatures');
    disbSigs.innerHTML = '';
    document.querySelectorAll('#disb-signatures .signature').forEach(sig => {
        const title = sig.querySelector('.disb-sign-title')?.value || '';
        const name = sig.querySelector('.disb-sign-name')?.value || '';
        if (title || name) {
            disbSigs.innerHTML += `
                <div class="pdf-signature">
                    <div class="pdf-signature-line"></div>
                    <div>${title}: ${name}</div>
                </div>
            `;
        }
    });

    // Add accountant signature
    const accountant = document.getElementById('disb-accountant').value;
    disbSigs.innerHTML += `
        <div class="pdf-signature">
            <div class="pdf-signature-line"></div>
            <div>Accountant: ${accountant}</div>
        </div>
    `;

    // Prepare Expense PDF
    const expCompany = document.getElementById('exp-company-select').value === 'Custom'
        ? document.getElementById('exp-company-custom').value
        : document.getElementById('exp-company-select').value;
    document.getElementById('pdf-exp-company-name').textContent = expCompany;
    document.getElementById('pdf-exp-fx').textContent = document.getElementById('exp-fx-rate').value;

    const origCurr = document.getElementById('exp-original-currency').value;
    const payCurr = document.getElementById('exp-payment-currency').value;
    document.getElementById('pdf-original-curr').textContent = origCurr;
    document.getElementById('pdf-payment-curr').textContent = payCurr;
    document.getElementById('pdf-exp-orig-curr').textContent = origCurr;
    document.getElementById('pdf-exp-pay-curr').textContent = payCurr;

    // Expense table
    const expTbody = document.getElementById('pdf-exp-tbody');
    expTbody.innerHTML = '';
    document.querySelectorAll('#expenseRows tr').forEach(tr => {
        const ref = tr.querySelector('.exp-ref').value;
        const date = tr.querySelector('.exp-item-date').value;
        const desc = tr.querySelector('.exp-description').value;
        const orig = tr.querySelector('.exp-amount-original').value;
        const pay = tr.querySelector('.exp-amount-payment').value;
        if(ref || date || desc || orig || pay) {
            expTbody.innerHTML += `<tr>
                <td>${ref}</td>
                <td>${date}</td>
                <td>${desc}</td>
                <td class="amount-col">${orig}</td>
                <td class="amount-col">${pay}</td>
            </tr>`;
        }
    });

    document.getElementById('pdf-exp-total-orig').textContent = document.getElementById('totalOriginal').textContent;
    document.getElementById('pdf-exp-total-pay').textContent = document.getElementById('totalPayment').textContent;
    document.getElementById('pdf-exp-applicant').textContent = document.getElementById('exp-applicant').value;
    document.getElementById('pdf-exp-applicant-date').textContent = document.getElementById('exp-date').value;

    // Generate PDF from disbursement page
    document.getElementById('pdf-disbursement').classList.add('printing');
    const disbCanvas = await html2canvas(document.getElementById('pdf-disbursement'), {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true
    });
    const disbImg = disbCanvas.toDataURL('image/png');
    const disbWidth = 210;
    const disbHeight = (disbCanvas.height * disbWidth) / disbCanvas.width;

    pdf.addImage(disbImg, 'PNG', 0, 0, disbWidth, disbHeight);
    document.getElementById('pdf-disbursement').classList.remove('printing');

    // Add new page for expenses
    pdf.addPage();

    // Generate PDF from expense page
    document.getElementById('pdf-expenses').classList.add('printing');
    const expCanvas = await html2canvas(document.getElementById('pdf-expenses'), {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true
    });
    const expImg = expCanvas.toDataURL('image/png');
    const expWidth = 210;
    const expHeight = (expCanvas.height * expWidth) / expCanvas.width;

    pdf.addImage(expImg, 'PNG', 0, 0, expWidth, expHeight);
    document.getElementById('pdf-expenses').classList.remove('printing');

    // Save PDF
    const today = new Date().toISOString().split('T')[0];
    pdf.save(`TPT_Disbursement_Expense_${today}.pdf`);
}

// Default dates and initialization
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('exp-date').value = today;
    document.getElementById('disb-date').value = today;
    document.getElementById('disb-paid-date').value = today;
    updatePaymentAmounts();
    calculateDisbursementTotal();
});
</script>
</body>
</html>


